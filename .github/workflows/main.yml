name: Test Inputs & Connectivity

on:
  workflow_dispatch:
    inputs:
      name:
        description: 'Your name'
        required: true
        type: string
        default: 'Friend'
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: dev
      debug:
        description: 'Enable debug mode?'
        required: false
        type: boolean
        default: false
      count:
        description: 'How many times to echo?'
        required: false
        type: number
        default: 1

jobs:
  simulate-and-report:
    runs-on: ubuntu-latest
    env:
      CALLBACK_URL: "https://deiform-nonruminatingly-aleah.ngrok-free.dev/webhook"  # CHANGE THIS
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show Inputs
        run: |
          echo "Hello, ${{ inputs.name }}!"
          echo "Environment: ${{ inputs.environment }}"
          echo "Debug: ${{ inputs.debug }}"
          echo "Count: ${{ inputs.count }}"
          echo "Starting work simulation..."

      # SIMULATE WORK (4â€“10 sec per task)
      - name: Process Task
        if: inputs.count > 0
        run: |
          for i in $(seq 1 ${{ inputs.count }}); do
            echo "[$i/${{ inputs.count }}] Running task in ${{ inputs.environment }}..."
            sleep $((4 + $RANDOM % 6))
            echo "[$i] Task complete!"
          done

      # FINAL DEPLOYMENT
      - name: Deploy
        run: |
          echo "Deploying to ${{ inputs.environment }}..."
          sleep 3
          echo "Deployment successful! (India Time: $(date '+%I:%M %p IST'))"

      # CALL YOUR API (WITH run_id, inputs, status)
      - name: Notify API
        run: |
          IST_TIME=$(date '+%I:%M %p IST, %d %b %Y')
          RUN_ID=${{ github.run_id }}
          STATUS="success"

          # If any step failed, set status to failure
          if [ "${{ job.status }}" != "success" ]; then
            STATUS="failure"
          fi

          curl -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "run_id": "'"$RUN_ID"'",
              "inputs": {
                "name": "'"${{ inputs.name }}"'",
                "environment": "'"${{ inputs.environment }}"'",
                "debug": ${{ inputs.debug }},
                "count": ${{ inputs.count }}
              },
              "status": "'"$STATUS"'",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/'"$RUN_ID"'",
              "completed_at_ist": "'"$IST_TIME"'"
            }' || echo "API call failed (ignored)"